<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmpÃ³rio Villa Borghese</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, orderBy, deleteDoc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // ConfiguraÃ§Ã£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD8koo2PIFHM9xMQKFUE_S88kJycFdC6mY",
            authDomain: "emporio-villa-borghese-6d20d.firebaseapp.com", 
            projectId: "emporio-villa-borghese-6d20d",
            storageBucket: "emporio-villa-borghese-6d20d.firebasestorage.app",
            messagingSenderId: "787583181332",
            appId: "1:787583181332:web:9cebcf996ada5e4fae7d01"
        };
        
        try {
            // Verificar se todas as configuraÃ§Ãµes estÃ£o corretas
            console.log('Iniciando Firebase com configuraÃ§Ã£o:', firebaseConfig);
            
            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            // Disponibilizar globalmente
            window.firebase = { 
                db, auth, collection, addDoc, getDocs, updateDoc, doc, 
                query, where, orderBy, deleteDoc, setDoc, getDoc,
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword, signOut, onAuthStateChanged 
            };
            
            // Testa a conexÃ£o bÃ¡sica
            console.log('Firebase inicializado, testando conexÃ£o...');
            
            // Aguarda um pouco para garantir que a conexÃ£o seja estabelecida
            setTimeout(async () => {
                try {
                    await getDocs(collection(db, 'test'));
                    console.log('ConexÃ£o com Firestore estabelecida com sucesso');
                } catch (testError) {
                    console.log('Teste de conexÃ£o (normal se coleÃ§Ã£o nÃ£o existir):', testError.message);
                }
            }, 1000);
            
        } catch (error) {
            console.error('Erro detalhado na inicializaÃ§Ã£o do Firebase:', error);
            console.log('ConfiguraÃ§Ã£o usada:', firebaseConfig);
            
            // Se falhar, cai para modo demo
            window.firebase = null;
            
            // Define dados de demonstraÃ§Ã£o
            window.demoMode = {
                users: [
                    { 
                        id: 'demo-admin', 
                        name: 'Admin Demo', 
                        email: 'admin@demo.com', 
                        password: 'admin123', 
                        setor: 'cpd',
                        loja: 'Azevedo',
                        isAdmin: true, 
                        status: 'ativo' 
                    },
                    { 
                        id: 'demo-user', 
                        name: 'UsuÃ¡rio Demo', 
                        email: 'usuario@demo.com', 
                        password: '123456', 
                        setor: 'balcao',
                        loja: 'Mato Grosso',
                        isAdmin: false, 
                        status: 'ativo' 
                    }
                ],
                orders: [],
                nextId: 1
            };
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff8a65 0%, #ff6f00 50%, #e65100 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff6b35, #ff8c42);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            color: #ff6b35;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #ff6b35;
            color: white;
        }

        .btn-primary:hover {
            background: #e55a15;
        }

        .btn-secondary {
            background: white;
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }

        .btn-secondary:hover {
            background: #ff6b35;
            color: white;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .hidden {
            display: none;
        }

        .calendar-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            font-weight: bold;
            color: #ff6b35;
            padding: 10px;
            font-size: 14px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            background: #f5f5f5;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            min-height: 40px;
        }

        .calendar-day:hover {
            background: rgba(255, 107, 53, 0.1);
            border-color: #ff6b35;
        }

        .calendar-day.selected {
            background: #ff6b35;
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.past {
            background: #eee;
            color: #999;
            cursor: not-allowed;
        }

        .calendar-day.today {
            border: 2px solid #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .menu-section {
            background: rgba(255, 245, 240, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 4px solid #ff6b35;
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-day {
            font-weight: bold;
            color: #ff6b35;
            width: 100px;
        }

        .menu-dish {
            flex: 1;
            margin-left: 15px;
        }

        .total-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            border: 2px solid rgba(33, 150, 243, 0.2);
        }

        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1976d2;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
            padding: 10px 20px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 20px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ff6b35;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            color: white;
        }

        .stats-card.primary { background: linear-gradient(135deg, #ff6b35, #ff8c42); }
        .stats-card.success { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .stats-card.info { background: linear-gradient(135deg, #2196F3, #1976d2); }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #ff6b35;
            color: white;
            font-weight: 500;
        }

        .table tr:hover {
            background: #fff5f0;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .badge.success { background: #4CAF50; }
        .badge.warning { background: #ff9800; }
        .badge.info { background: #2196F3; }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            max-width: 350px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .toast.success { background: #4CAF50; }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }
        .toast.info { background: #2196F3; }

        .firebase-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }

        .firebase-status.connected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .firebase-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }
            
            .nav-buttons {
                justify-content: center;
                width: 100%;
            }

            .calendar-day {
                min-height: 35px;
                font-size: 12px;
            }

            .menu-item {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ½ï¸</div>
                <h1 class="logo-text">EmpÃ³rio Villa Borghese</h1>
            </div>
            <nav class="nav-buttons">
                <div class="user-info hidden" id="userInfo">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">UsuÃ¡rio</span>
                </div>
                <button class="btn btn-primary" onclick="showLogin()" id="loginBtn">ğŸ” Login</button>
                <button class="btn btn-secondary" onclick="showRegister()" id="registerBtn">ğŸ“ Cadastro</button>
                <button class="btn btn-primary hidden" onclick="showDashboard()" id="dashboardBtn">ğŸ  Dashboard</button>
                <button class="btn btn-secondary hidden" onclick="showOrders()" id="ordersBtn">ğŸ“‹ Pedidos</button>
                <button class="btn btn-success hidden" onclick="showReports()" id="reportsBtn">ğŸ“Š RelatÃ³rios</button>
                <button class="btn btn-warning hidden" onclick="showAdmin()" id="adminBtn">âš™ï¸ Admin</button>
                <button class="btn btn-danger hidden" onclick="logout()" id="logoutBtn">ğŸšª Sair</button>
            </nav>
        </header>

        <!-- Login -->
        <div class="card" id="loginForm">
            <h2 style="color: #ff6b35; margin-bottom: 25px;">ğŸ” Login</h2>
            
            <div id="firebaseStatus" class="firebase-status error">
                ğŸ”— Conectando ao Firebase...
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">ğŸ“§ Email:</label>
                    <input type="email" id="loginEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">ğŸ”’ Senha:</label>
                    <input type="password" id="loginPassword" required placeholder="Digite sua senha">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 16px;" id="loginSubmitBtn">ğŸš€ Entrar</button>
            </form>
        </div>

        <!-- Cadastro -->
        <div class="card hidden" id="registerForm">
            <h2 style="color: #ff6b35; margin-bottom: 25px;">ğŸ“ Cadastro</h2>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="registerName">ğŸ‘¤ Nome:</label>
                    <input type="text" id="registerName" required placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="registerEmail">ğŸ“§ Email:</label>
                    <input type="email" id="registerEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">ğŸ”’ Senha:</label>
                    <input type="password" id="registerPassword" required minlength="6" placeholder="MÃ­nimo 6 caracteres">
                </div>
                <div class="form-group">
                    <label for="registerSetor">ğŸ¢ Setor:</label>
                    <select id="registerSetor" required>
                        <option value="">Selecione o setor</option>
                        <option value="flv">ğŸ¥¬ FLV</option>
                        <option value="balcao">ğŸ›’ BalcÃ£o</option>
                        <option value="frente_caixa">ğŸ’³ Frente de Caixa</option>
                        <option value="financeiro">ğŸ’° Financeiro</option>
                        <option value="cpd">ğŸ’» CPD</option>
                        <option value="rh">ğŸ‘¥ RH</option>
                        <option value="vinhos">ğŸ· Vinhos</option>
                        <option value="compras">ğŸ“¦ Compras</option>
                        <option value="limpeza">ğŸ§¹ Limpeza</option>
                        <option value="padaria_confeitaria">ğŸ Padaria e Confeitaria</option>
                        <option value="portaria">ğŸšª Portaria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="registerLoja">ğŸª Loja:</label>
                    <select id="registerLoja" required>
                        <option value="">Selecione a loja</option>
                        <option value="Azevedo">ğŸª Azevedo</option>
                        <option value="Mato Grosso">ğŸª Mato Grosso</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 16px;">âœ¨ Criar Conta</button>
            </form>
        </div>

        <!-- Dashboard -->
        <div class="hidden" id="dashboard">
            <div class="card">
                <h2 style="color: #ff6b35; margin-bottom: 20px;">ğŸ½ï¸ Pedido de Marmita</h2>
                
                <div style="background: rgba(76, 175, 80, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ½ï¸ MARMITA COLABORADORES - R$ <span id="priceDisplay">18,50</span>/dia</h3>
                </div>
                
                <p style="font-weight: 600; margin-bottom: 15px;">ğŸ“… Selecione as datas:</p>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">â€¹ Anterior</button>
                        <h3 id="currentMonth" style="margin: 0; color: #ff6b35;"></h3>
                        <button class="calendar-nav" onclick="changeMonth(1)">PrÃ³ximo â€º</button>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="weekday">Dom</div>
                        <div class="weekday">Seg</div>
                        <div class="weekday">Ter</div>
                        <div class="weekday">Qua</div>
                        <div class="weekday">Qui</div>
                        <div class="weekday">Sex</div>
                        <div class="weekday">SÃ¡b</div>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- Dias gerados por JavaScript -->
                    </div>
                </div>

                <div class="menu-section">
                    <h3 style="color: #ff6b35; margin-bottom: 15px;">ğŸ½ï¸ CardÃ¡pio da Semana</h3>
                    <div class="menu-item">
                        <div class="menu-day">â˜€ï¸ Domingo</div>
                        <div class="menu-dish" id="menuSunday">Carregando...</div>
                    </div>
                    <div class="menu-item">
                        <div class="menu-day">ğŸŒ… Segunda</div>
                        <div class="menu-dish" id="menuMonday">Carregando...</div>
                    </div>
                    <div class="menu-item">
                        <div class="menu-day">ğŸŒŸ TerÃ§a</div>
                        <div class="menu-dish" id="menuTuesday">Carregando...</div>
                    </div>
                    <div class="menu-item">
                        <div class="menu-day">ğŸŒ¸ Quarta</div>
                        <div class="menu-dish" id="menuWednesday">Carregando...</div>
                    </div>
                    <div class="menu-item">
                        <div class="menu-day">ğŸŒ¿ Quinta</div>
                        <div class="menu-dish" id="menuThursday">Carregando...</div>
                    </div>
                    <div class="menu-item">
                        <div class="menu-day">ğŸ‰ Sexta</div>
                        <div class="menu-dish" id="menuFriday">Carregando...</div>
                    </div>
                    <div class="menu-item">
                        <div class="menu-day">ğŸŒˆ SÃ¡bado</div>
                        <div class="menu-dish" id="menuSaturday">Carregando...</div>
                    </div>
                </div>

                <div class="total-section">
                    <div class="total-amount">
                        ğŸ’° Total: R$ <span id="totalPrice">0,00</span> (<span id="selectedDays">0</span> dias)
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">
                        <span id="selectedDatesInfo">Nenhuma data selecionada</span>
                    </div>
                </div>

                <div style="margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveOrder()">ğŸ’¾ Salvar Pedido</button>
                    <button class="btn btn-secondary" onclick="clearDates()">ğŸ—‘ï¸ Limpar</button>
                    <button class="btn btn-warning" onclick="goToToday()">ğŸ“… Hoje</button>
                </div>
            </div>
        </div>

        <!-- Pedidos -->
        <div class="hidden" id="ordersSection">
            <div class="card">
                <h2 style="color: #ff6b35; margin-bottom: 20px;">ğŸ“‹ Meus Pedidos</h2>
                
                <div class="stats-grid">
                    <div class="stats-card primary">
                        <div class="stats-number" id="myTotalOrders">0</div>
                        <div>Total Pedidos</div>
                    </div>
                    <div class="stats-card success">
                        <div class="stats-number" id="myTotalSpent">R$ 0</div>
                        <div>Total Gasto</div>
                    </div>
                    <div class="stats-card info">
                        <div class="stats-number" id="myFavoriteDay">-</div>
                        <div>Dia Favorito</div>
                    </div>
                </div>

                <div id="ordersLoading" class="loading">ğŸ”„ Carregando pedidos...</div>
                <table class="table hidden" id="ordersTable">
                    <thead>
                        <tr>
                            <th>ğŸ“… Data</th>
                            <th>ğŸ½ï¸ Datas Selecionadas</th>
                            <th>ğŸ’° Valor</th>
                            <th>ğŸ“Š Status</th>
                            <th>âš¡ AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- RelatÃ³rios -->
        <div class="hidden" id="reports">
            <div class="card">
                <h2 style="color: #ff6b35; margin-bottom: 20px;">ğŸ“Š RelatÃ³rios</h2>
                
                <div style="margin-bottom: 25px;">
                    <button class="btn btn-primary" onclick="generateReport()">ğŸ“Š Gerar RelatÃ³rio</button>
                    <button class="btn btn-success" onclick="exportCSV()">ğŸ“‹ Exportar CSV</button>
                    <button class="btn btn-warning" onclick="exportPDF()">ğŸ“„ Exportar PDF</button>
                    <button class="btn btn-secondary" onclick="showLabelSelector()">ğŸ·ï¸ Gerar Etiquetas</button>
                </div>

                <div class="stats-grid">
                    <div class="stats-card primary">
                        <div class="stats-number" id="totalOrders">0</div>
                        <div>Total Pedidos</div>
                    </div>
                    <div class="stats-card success">
                        <div class="stats-number" id="totalRevenue">R$ 0</div>
                        <div>Receita Total</div>
                    </div>
                    <div class="stats-card info">
                        <div class="stats-number" id="totalUsers">0</div>
                        <div>UsuÃ¡rios</div>
                    </div>
                </div>

                <div id="reportLoading" class="loading">ğŸ”„ Carregando relatÃ³rio...</div>
                <table class="table hidden" id="reportTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAllOrders" onchange="toggleAllOrders(this)" style="margin-right: 5px;">
                                Selecionar
                            </th>
                            <th>ğŸ‘¤ UsuÃ¡rio</th>
                            <th>ğŸ¢ Setor</th>
                            <th>ğŸª Loja</th>
                            <th>ğŸ“… Datas (Dia da Semana)</th>
                            <th>ğŸ’° Valor</th>
                            <th>ğŸ“… Data Pedido</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>

                <!-- Modal para seleÃ§Ã£o de etiquetas -->
                <div id="labelModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; margin: 50px auto; position: relative;">
                        <button onclick="closeLabelModal()" style="position: absolute; top: 15px; right: 15px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">Ã—</button>
                        
                        <h3 style="color: #ff6b35; margin-bottom: 20px;">ğŸ·ï¸ Selecionar Pedidos para Etiquetas</h3>
                        <p style="margin-bottom: 20px; color: #666;">Selecione os pedidos para gerar etiquetas:</p>
                        
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-secondary" onclick="selectAllModalOrders()" style="margin-right: 10px;">âœ… Selecionar Todos</button>
                            <button class="btn btn-secondary" onclick="unselectAllModalOrders()">âŒ Limpar SeleÃ§Ã£o</button>
                        </div>
                        
                        <div id="labelOrdersList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px;">
                            <!-- Lista de pedidos serÃ¡ gerada aqui -->
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-danger" onclick="closeLabelModal()">âŒ Cancelar</button>
                            <button class="btn btn-primary" onclick="generateSelectedLabels()">ğŸ·ï¸ Gerar Etiquetas Selecionadas</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin -->
        <div class="hidden" id="adminPanel">
            <div class="card">
                <h2 style="color: #ff6b35; margin-bottom: 20px;">âš™ï¸ Painel Admin</h2>
                
                <div class="grid-2">
                    <div>
                        <h3>ğŸ’² ConfiguraÃ§Ãµes</h3>
                        <div class="form-group">
                            <label>PreÃ§o por Marmita (R$):</label>
                            <input type="number" id="mealPriceInput" value="18.50" step="0.01" min="0.01">
                        </div>
                        <button class="btn btn-primary" onclick="updatePrice()">ğŸ’¾ Atualizar PreÃ§o</button>
                    </div>
                    
                    <div>
                        <h3>ğŸ› ï¸ AÃ§Ãµes</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-secondary" onclick="generateRandomMenu()">ğŸ² CardÃ¡pio AleatÃ³rio</button>
                            <button class="btn btn-warning" onclick="resetAllData()">ğŸ—‘ï¸ Reset Sistema</button>
                        </div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px 0; color: #ff6b35;">ğŸ½ï¸ Editar CardÃ¡pio</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label>â˜€ï¸ Domingo:</label>
                        <input type="text" id="menuSundayInput" placeholder="Carregando...">
                    </div>
                    <div class="form-group">
                        <label>ğŸŒ… Segunda:</label>
                        <input type="text" id="menuMondayInput" placeholder="Carregando...">
                    </div>
                    <div class="form-group">
                        <label>ğŸŒŸ TerÃ§a:</label>
                        <input type="text" id="menuTuesdayInput" placeholder="Carregando...">
                    </div>
                    <div class="form-group">
                        <label>ğŸŒ¸ Quarta:</label>
                        <input type="text" id="menuWednesdayInput" placeholder="Carregando...">
                    </div>
                    <div class="form-group">
                        <label>ğŸŒ¿ Quinta:</label>
                        <input type="text" id="menuThursdayInput" placeholder="Carregando...">
                    </div>
                    <div class="form-group">
                        <label>ğŸ‰ Sexta:</label>
                        <input type="text" id="menuFridayInput" placeholder="Carregando...">
                    </div>
                    <div class="form-group">
                        <label>ğŸŒˆ SÃ¡bado:</label>
                        <input type="text" id="menuSaturdayInput" placeholder="Carregando...">
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-primary" onclick="updateMenu()">ğŸ½ï¸ Atualizar CardÃ¡pio</button>
                    <button class="btn btn-secondary" onclick="generateRandomMenu()">ğŸ² CardÃ¡pio AleatÃ³rio</button>
                </div>

                <h3 style="margin: 30px 0 15px 0;">ğŸ‘¥ UsuÃ¡rios</h3>
                <div id="usersLoading" class="loading">ğŸ”„ Carregando usuÃ¡rios...</div>
                <table class="table hidden" id="usersTable">
                    <thead>
                        <tr>
                            <th>ğŸ‘¤ Nome</th>
                            <th>ğŸ“§ Email</th>
                            <th>ğŸ¢ Setor</th>
                            <th>ğŸª Loja</th>
                            <th>ğŸ·ï¸ Tipo</th>
                            <th>ğŸ“Š Status</th>
                            <th>âš¡ AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
                    <h4 style="color: #856404; margin: 0 0 15px 0;">ğŸ‘‘ Promover Administrador</h4>
                    <p style="color: #856404; margin-bottom: 15px; font-size: 14px;">
                        <strong>Emails que automaticamente viram admin:</strong><br>
                        â€¢ admin@villaborghese.com<br>
                        â€¢ administrador@villaborghese.com<br>
                        â€¢ chef@villaborghese.com<br>
                        â€¢ Primeiro usuÃ¡rio registrado
                    </p>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="email" id="promoteEmail" placeholder="Email do usuÃ¡rio" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <button class="btn btn-warning" onclick="promoteToAdmin()">ğŸ‘‘ Promover para Admin</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VariÃ¡veis globais
        let currentUser = null;
        let mealPrice = 18.50;
        let currentDate = new Date();
        let selectedDates = new Set();
        let firebaseInitialized = false;
        let allOrders = [];
        let allUsers = [];
        
        let weeklyMenu = {
            0: 'Paella valenciana especial',
            1: 'Risotto de funghi com trufas',
            2: 'SalmÃ£o grelhado mediterrÃ¢neo',
            3: 'Osso buco milanÃªs',
            4: 'Lasanha de berinjela',
            5: 'Risotto de camarÃ£o',
            6: 'Costela 12h com gnocchi'
        };

        // InicializaÃ§Ã£o do Firebase
        async function initFirebase() {
            try {
                if (window.firebase && window.firebase.auth) {
                    console.log('Firebase detectado, configurando autenticaÃ§Ã£o...');
                    
                    // Monitora mudanÃ§as de autenticaÃ§Ã£o
                    window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                        if (user) {
                            console.log('UsuÃ¡rio logado no Firebase:', user.email);
                            await loadUserProfile(user);
                        } else {
                            console.log('UsuÃ¡rio deslogado do Firebase');
                            currentUser = null;
                            updateUI();
                        }
                    });
                    
                    // Carrega dados iniciais
                    await loadInitialData();
                    firebaseInitialized = true;
                    updateFirebaseStatus('âœ… Conectado ao Firebase em produÃ§Ã£o', 'connected');
                    console.log('Firebase inicializado com sucesso em modo produÃ§Ã£o');
                } else {
                    throw new Error('Firebase nÃ£o foi inicializado corretamente');
                }
            } catch (error) {
                console.warn('Falha na inicializaÃ§Ã£o do Firebase, usando modo demonstraÃ§Ã£o:', error);
                firebaseInitialized = false;
                updateFirebaseStatus('âš ï¸ Modo DemonstraÃ§Ã£o - Firebase nÃ£o configurado', 'error');
                
                // Adiciona informaÃ§Ãµes de demonstraÃ§Ã£o
                addDemoInfo();
            }
        }

        // Adiciona informaÃ§Ãµes sobre o modo demo
        function addDemoInfo() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm && !document.getElementById('demoInfo')) {
                const demoInfo = document.createElement('div');
                demoInfo.id = 'demoInfo';
                demoInfo.style.cssText = 'margin-top: 20px; text-align: center; padding: 20px; background: #e3f2fd; border-radius: 8px; border: 1px solid #2196f3;';
                demoInfo.innerHTML = `
                    <strong style="color: #1976d2;">ğŸ§ª Modo DemonstraÃ§Ã£o</strong><br><br>
                    <strong>Contas de Teste:</strong><br>
                    <strong>Admin:</strong> admin@demo.com / admin123<br>
                    <strong>UsuÃ¡rio:</strong> usuario@demo.com / 123456<br><br>
                    <small style="color: #666;">Para usar em produÃ§Ã£o, configure suas credenciais do Firebase no cÃ³digo.</small>
                `;
                loginForm.appendChild(demoInfo);
            }
        }

        function updateFirebaseStatus(message, type) {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'firebase-status ' + type;
            }
        }

        // Carrega dados iniciais do Firebase
        async function loadInitialData() {
            try {
                console.log('Carregando dados iniciais...');
                await loadMenuFromFirebase();
                await loadConfigFromFirebase();
                
                // Garantir que weeklyMenu esteja populado
                if (!weeklyMenu || Object.keys(weeklyMenu).length === 0) {
                    console.log('Menu vazio, usando padrÃ£o...');
                    weeklyMenu = {
                        0: 'Paella valenciana especial',
                        1: 'Risotto de funghi com trufas',
                        2: 'SalmÃ£o grelhado mediterrÃ¢neo',
                        3: 'Osso buco milanÃªs',
                        4: 'Lasanha de berinjela',
                        5: 'Risotto de camarÃ£o',
                        6: 'Costela 12h com gnocchi'
                    };
                }
                
                console.log('Menu carregado:', weeklyMenu);
                console.log('Dados iniciais carregados do Firebase');
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                // Menu padrÃ£o em caso de erro
                weeklyMenu = {
                    0: 'Paella valenciana especial',
                    1: 'Risotto de funghi com trufas',
                    2: 'SalmÃ£o grelhado mediterrÃ¢neo',
                    3: 'Osso buco milanÃªs',
                    4: 'Lasanha de berinjela',
                    5: 'Risotto de camarÃ£o',
                    6: 'Costela 12h com gnocchi'
                };
            }
        }

        // FunÃ§Ãµes do Firebase - UsuÃ¡rios
        async function saveUserProfile(userData) {
            if (!firebaseInitialized) throw new Error('Firebase nÃ£o inicializado');
            
            try {
                const { db, setDoc, doc } = window.firebase;
                await setDoc(doc(db, 'users', userData.email), {
                    ...userData,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                console.log('Perfil salvo no Firebase');
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                throw error;
            }
        }

        async function loadUserProfile(firebaseUser) {
            if (!firebaseInitialized) return;
            
            try {
                console.log('Carregando perfil para:', firebaseUser.email);
                
                // Aguarda um pouco para garantir que o perfil foi salvo
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const { db, doc, getDoc } = window.firebase;
                const userDoc = await getDoc(doc(db, 'users', firebaseUser.email));
                
                if (userDoc.exists()) {
                    currentUser = { id: userDoc.id, ...userDoc.data() };
                    console.log('Perfil carregado com sucesso:', currentUser);
                    updateUI();
                    
                    // SÃ³ mostra dashboard se nÃ£o estiver jÃ¡ visÃ­vel
                    if (document.getElementById('dashboard').classList.contains('hidden')) {
                        showDashboard();
                        showNotification('Bem-vindo, ' + currentUser.name + '!', 'success');
                    }
                } else {
                    console.log('Perfil nÃ£o encontrado para:', firebaseUser.email);
                    
                    // Em vez de fazer logout imediatamente, aguarda mais um pouco
                    console.log('Tentando novamente em 2 segundos...');
                    setTimeout(async () => {
                        const retryDoc = await getDoc(doc(db, 'users', firebaseUser.email));
                        if (retryDoc.exists()) {
                            currentUser = { id: retryDoc.id, ...retryDoc.data() };
                            console.log('Perfil carregado na segunda tentativa:', currentUser);
                            updateUI();
                            showDashboard();
                            showNotification('Bem-vindo, ' + currentUser.name + '!', 'success');
                        } else {
                            console.log('Perfil ainda nÃ£o encontrado, fazendo logout...');
                            showNotification('Perfil nÃ£o encontrado. Fazendo logout...', 'warning');
                            const { signOut, auth } = window.firebase;
                            await signOut(auth);
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                showNotification('Erro ao carregar perfil: ' + error.message, 'error');
                
                // Faz logout em caso de erro
                try {
                    const { signOut, auth } = window.firebase;
                    await signOut(auth);
                } catch (logoutError) {
                    console.error('Erro no logout:', logoutError);
                }
            }
        }

        async function loadAllUsers() {
            if (!firebaseInitialized) return [];
            
            try {
                const { db, collection, getDocs } = window.firebase;
                const querySnapshot = await getDocs(collection(db, 'users'));
                
                allUsers = [];
                querySnapshot.forEach((doc) => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });
                
                return allUsers;
            } catch (error) {
                console.error('Erro ao carregar usuÃ¡rios:', error);
                return [];
            }
        }

        // FunÃ§Ãµes do Firebase - Pedidos
        async function saveOrderToFirebase(orderData) {
            if (!firebaseInitialized) throw new Error('Firebase nÃ£o inicializado');
            
            try {
                const { db, collection, addDoc } = window.firebase;
                const docRef = await addDoc(collection(db, 'orders'), {
                    ...orderData,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                console.log('Pedido salvo com ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                throw error;
            }
        }

        async function loadAllOrders() {
            if (!firebaseInitialized) return [];
            
            try {
                console.log('Carregando todos os pedidos...');
                const { db, collection, getDocs } = window.firebase;
                
                // Query simples sem orderBy para evitar problemas de Ã­ndice
                const querySnapshot = await getDocs(collection(db, 'orders'));
                
                const orders = [];
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordena localmente por data de criaÃ§Ã£o
                orders.sort((a, b) => {
                    const dateA = a.createdAt?.toDate() || new Date(0);
                    const dateB = b.createdAt?.toDate() || new Date(0);
                    return dateB - dateA; // Mais recente primeiro
                });
                
                console.log('Total de pedidos carregados:', orders.length);
                return orders;
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                return [];
            }
        }

        async function loadMyOrdersFromFirebase() {
            if (!firebaseInitialized || !currentUser) return [];
            
            try {
                console.log('Carregando pedidos do usuÃ¡rio:', currentUser.email);
                const { db, collection, query, where, getDocs } = window.firebase;
                
                // Query mais simples sem orderBy para evitar erro de Ã­ndice
                const q = query(
                    collection(db, 'orders'),
                    where('userEmail', '==', currentUser.email)
                );
                const querySnapshot = await getDocs(q);
                
                const userOrders = [];
                querySnapshot.forEach((doc) => {
                    userOrders.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordena localmente por data de criaÃ§Ã£o
                userOrders.sort((a, b) => {
                    const dateA = a.createdAt?.toDate() || new Date(0);
                    const dateB = b.createdAt?.toDate() || new Date(0);
                    return dateB - dateA; // Mais recente primeiro
                });
                
                console.log('Pedidos do usuÃ¡rio carregados:', userOrders.length);
                return userOrders;
            } catch (error) {
                console.error('Erro ao carregar meus pedidos:', error);
                return [];
            }
        }

        async function cancelOrderInFirebase(orderId) {
            if (!firebaseInitialized) throw new Error('Firebase nÃ£o inicializado');
            
            try {
                const { db, doc, updateDoc } = window.firebase;
                await updateDoc(doc(db, 'orders', orderId), {
                    status: 'cancelado',
                    updatedAt: new Date()
                });
                console.log('Pedido cancelado:', orderId);
            } catch (error) {
                console.error('Erro ao cancelar pedido:', error);
                throw error;
            }
        }

        // FunÃ§Ãµes do Firebase - Menu
        async function saveMenuToFirebase() {
            if (!firebaseInitialized) throw new Error('Firebase nÃ£o inicializado');
            
            try {
                const { db, setDoc, doc } = window.firebase;
                await setDoc(doc(db, 'config', 'menu'), {
                    type: 'menu',
                    data: weeklyMenu,
                    updatedAt: new Date()
                });
                console.log('Menu salvo no Firebase');
            } catch (error) {
                console.error('Erro ao salvar menu:', error);
                throw error;
            }
        }

        async function loadMenuFromFirebase() {
            if (!firebaseInitialized) return;
            
            try {
                const { db, doc, getDoc } = window.firebase;
                const menuDoc = await getDoc(doc(db, 'config', 'menu'));
                
                if (menuDoc.exists()) {
                    const menuData = menuDoc.data();
                    weeklyMenu = menuData.data || weeklyMenu;
                    console.log('Menu carregado do Firebase');
                }
            } catch (error) {
                console.error('Erro ao carregar menu:', error);
            }
        }

        // FunÃ§Ãµes do Firebase - ConfiguraÃ§Ãµes
        async function saveConfigToFirebase() {
            if (!firebaseInitialized) throw new Error('Firebase nÃ£o inicializado');
            
            try {
                const { db, setDoc, doc } = window.firebase;
                await setDoc(doc(db, 'config', 'settings'), {
                    type: 'settings',
                    mealPrice: mealPrice,
                    updatedAt: new Date()
                });
                console.log('ConfiguraÃ§Ãµes salvas no Firebase');
            } catch (error) {
                console.error('Erro ao salvar configuraÃ§Ãµes:', error);
                throw error;
            }
        }

        async function loadConfigFromFirebase() {
            if (!firebaseInitialized) return;
            
            try {
                const { db, doc, getDoc } = window.firebase;
                const configDoc = await getDoc(doc(db, 'config', 'settings'));
                
                if (configDoc.exists()) {
                    const config = configDoc.data();
                    mealPrice = config.mealPrice || mealPrice;
                    console.log('ConfiguraÃ§Ãµes carregadas do Firebase');
                }
            } catch (error) {
                console.error('Erro ao carregar configuraÃ§Ãµes:', error);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const submitBtn = document.getElementById('loginSubmitBtn');
            
            // Desabilita botÃ£o durante o login
            submitBtn.disabled = true;
            submitBtn.textContent = 'ğŸ”„ Entrando...';
            
            try {
                if (firebaseInitialized) {
                    console.log('Tentando login com Firebase para:', email);
                    // Login com Firebase
                    const { signInWithEmailAndPassword, auth } = window.firebase;
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    
                    console.log('Login realizado no Firebase, carregando perfil...');
                    // O perfil serÃ¡ carregado automaticamente pelo onAuthStateChanged
                    showNotification('Login realizado com sucesso!', 'success');
                } else {
                    // Modo demonstraÃ§Ã£o - login local
                    const user = window.demoMode.users.find(u => u.email === email && u.password === password);
                    if (user) {
                        currentUser = user;
                        updateUI();
                        showNotification('Bem-vindo ao modo demonstraÃ§Ã£o, ' + user.name + '!', 'success');
                        showDashboard();
                    } else {
                        throw new Error('Email ou senha incorretos! Use as contas de teste.');
                    }
                }
                
                // Limpa formulÃ¡rio
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                
            } catch (error) {
                console.error('Erro no login:', error);
                let errorMessage = 'Erro ao fazer login';
                
                if (firebaseInitialized) {
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'UsuÃ¡rio nÃ£o encontrado';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Senha incorreta';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Email invÃ¡lido';
                    } else if (error.code === 'auth/invalid-credential') {
                        errorMessage = 'Email ou senha incorretos';
                    } else {
                        errorMessage = error.message;
                    }
                } else {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                // Reabilita botÃ£o
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ Entrar';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const setor = document.getElementById('registerSetor').value;
            const loja = document.getElementById('registerLoja').value;
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ğŸ”„ Criando conta...';
            
            try {
                if (firebaseInitialized) {
                    console.log('Criando conta no Firebase para:', email);
                    
                    // Verifica se Ã© o primeiro usuÃ¡rio (antes de criar a conta)
                    const isFirstUser = await checkIfFirstUser();
                    
                    // Lista de emails que sempre serÃ£o admin
                    const adminEmails = [
                        'admin@emporio-villa-borghese.com',
                        'administrador@emporio-villa-borghese.com',
                        'chef@emporio-villa-borghese.com',
                        'matheus@emporiovillaborghese.com.br'
                    ];
                    
                    const isAdminEmail = adminEmails.includes(email.toLowerCase());
                    
                    // Preparar dados do usuÃ¡rio ANTES de criar a conta
                    const userData = {
                        name: name,
                        email: email,
                        setor: setor,
                        loja: loja,
                        isAdmin: isFirstUser || isAdminEmail,
                        status: 'ativo'
                    };
                    
                    // PRIMEIRO: Salva o perfil no Firestore
                    console.log('Salvando perfil no Firestore ANTES de criar autenticaÃ§Ã£o...');
                    await saveUserProfile(userData);
                    console.log('Perfil salvo com sucesso no Firestore');
                    
                    // SEGUNDO: Cria a conta no Firebase Auth
                    const { createUserWithEmailAndPassword, auth } = window.firebase;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log('Conta criada no Firebase Auth');
                    
                    // Adiciona o UID do Firebase ao perfil
                    userData.firebaseUid = userCredential.user.uid;
                    await saveUserProfile(userData); // Atualiza com UID
                    
                    // Define o usuÃ¡rio atual imediatamente
                    currentUser = userData;
                    console.log('UsuÃ¡rio definido:', currentUser);
                    
                    if (userData.isAdmin) {
                        showNotification('Conta de ADMINISTRADOR criada com sucesso! ğŸ‘‘', 'success');
                    } else {
                        showNotification('Conta criada com sucesso!', 'success');
                    }
                    
                    // Atualiza UI e vai para dashboard
                    updateUI();
                    showDashboard();
                    
                } else {
                    // Modo demonstraÃ§Ã£o - registro local
                    if (window.demoMode.users.find(u => u.email === email)) {
                        throw new Error('Email jÃ¡ cadastrado no modo demonstraÃ§Ã£o!');
                    }
                    
                    // Emails admin para modo demonstraÃ§Ã£o
                    const adminEmails = [
                        'admin@emporio-villa-borghese.com',
                        'administrador@emporio-villa-borghese.com', 
                        'chef@emporio-villa-borghese.com',
                        'matheus@emporiovillaborghese.com.br'
                    ];
                    
                    const isAdmin = adminEmails.includes(email.toLowerCase()) || window.demoMode.users.length === 0;
                    
                    const newUser = {
                        id: 'demo-' + Date.now(),
                        name: name,
                        email: email,
                        password: password,
                        setor: setor,
                        loja: loja,
                        isAdmin: isAdmin,
                        status: 'ativo'
                    };
                    
                    window.demoMode.users.push(newUser);
                    
                    if (isAdmin) {
                        showNotification('Conta de ADMINISTRADOR criada no modo demonstraÃ§Ã£o! ğŸ‘‘', 'success');
                    } else {
                        showNotification('Conta criada no modo demonstraÃ§Ã£o!', 'success');
                    }
                    
                    // Login automÃ¡tico no modo demo
                    currentUser = newUser;
                    updateUI();
                    showDashboard();
                }
                
                event.target.reset();
                
            } catch (error) {
                console.error('Erro no registro:', error);
                let errorMessage = 'Erro ao criar conta';
                
                if (firebaseInitialized) {
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email jÃ¡ estÃ¡ em uso';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Senha muito fraca (mÃ­nimo 6 caracteres)';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Email invÃ¡lido';
                    } else {
                        errorMessage = error.message;
                    }
                } else {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
                showLogin(); // Volta para o login em caso de erro
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ¨ Criar Conta';
            }
        }

        // FunÃ§Ã£o para verificar se Ã© o primeiro usuÃ¡rio
        async function checkIfFirstUser() {
            if (!firebaseInitialized) return false;
            
            try {
                const { db, collection, getDocs } = window.firebase;
                const querySnapshot = await getDocs(collection(db, 'users'));
                return querySnapshot.empty; // Se nÃ£o hÃ¡ usuÃ¡rios, Ã© o primeiro
            } catch (error) {
                console.error('Erro ao verificar primeiro usuÃ¡rio:', error);
                return false;
            }
        }

        async function logout() {
            try {
                if (firebaseInitialized) {
                    const { signOut, auth } = window.firebase;
                    await signOut(auth);
                } else {
                    currentUser = null;
                    updateUI();
                }
                
                selectedDates.clear();
                showLogin();
                showNotification('Logout realizado!', 'info');
                
            } catch (error) {
                console.error('Erro no logout:', error);
                showNotification('Erro ao fazer logout', 'error');
            }
        }

        // FunÃ§Ãµes de navegaÃ§Ã£o
        function showNotification(message, type = 'success') {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 4000);
        }

        function hideAll() {
            const sections = ['loginForm', 'registerForm', 'dashboard', 'ordersSection', 'reports', 'adminPanel'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            
            // Garante que o modal de etiquetas esteja fechado tambÃ©m
            const modal = document.getElementById('labelModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showLogin() {
            hideAll();
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function showRegister() {
            hideAll();
            document.getElementById('registerForm').classList.remove('hidden');
        }

        async function showDashboard() {
            if (!currentUser) {
                showNotification('VocÃª precisa fazer login primeiro!', 'warning');
                return showLogin();
            }
            hideAll();
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Carrega dados mais recentes ao abrir dashboard
            try {
                if (firebaseInitialized) {
                    await loadMenuFromFirebase();
                    await loadConfigFromFirebase();
                }
                await updatePriceDisplay();
                await updateMenuDisplay();
                generateCalendar();
                calculateTotal();
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        async function showOrders() {
            if (!currentUser) {
                showNotification('VocÃª precisa fazer login primeiro!', 'warning');
                return showLogin();
            }
            hideAll();
            document.getElementById('ordersSection').classList.remove('hidden');
            await loadMyOrders();
        }

        async function showReports() {
            if (!currentUser || !currentUser.isAdmin) {
                showNotification('Acesso negado! Apenas administradores.', 'error');
                return;
            }
            hideAll();
            
            // Garante que o modal esteja fechado
            const modal = document.getElementById('labelModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            document.getElementById('reports').classList.remove('hidden');
            await generateReport();
        }

        async function showAdmin() {
            if (!currentUser || !currentUser.isAdmin) {
                showNotification('Acesso negado! Apenas administradores.', 'error');
                return;
            }
            hideAll();
            document.getElementById('adminPanel').classList.remove('hidden');
            await loadAdminPanel();
        }

        // FunÃ§Ãµes do calendÃ¡rio
        function generateCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            const currentMonthElement = document.getElementById('currentMonth');
            
            if (!calendarDays || !currentMonthElement) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = [
                'Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            currentMonthElement.textContent = monthNames[month] + ' ' + year;
            
            calendarDays.innerHTML = '';
            
            const firstDay = new Date(year, month, 1);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                const dateString = date.toISOString().split('T')[0];
                dayElement.dataset.date = dateString;
                
                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                } else {
                    if (date < today) {
                        dayElement.classList.add('past');
                    } else {
                        dayElement.addEventListener('click', () => toggleDate(dateString, dayElement));
                    }
                    
                    if (date.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    if (selectedDates.has(dateString)) {
                        dayElement.classList.add('selected');
                    }
                }
                
                calendarDays.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
        }

        function toggleDate(dateString, dayElement) {
            if (selectedDates.has(dateString)) {
                selectedDates.delete(dateString);
                dayElement.classList.remove('selected');
            } else {
                selectedDates.add(dateString);
                dayElement.classList.add('selected');
            }
            calculateTotal();
            updateSelectedDatesInfo();
        }

        function clearDates() {
            selectedDates.clear();
            const selectedElements = document.querySelectorAll('.calendar-day.selected');
            selectedElements.forEach(element => element.classList.remove('selected'));
            calculateTotal();
            updateSelectedDatesInfo();
            showNotification('SeleÃ§Ã£o limpa!', 'info');
        }

        function goToToday() {
            currentDate = new Date();
            generateCalendar();
            showNotification('Voltou para o mÃªs atual!', 'info');
        }

        function updateSelectedDatesInfo() {
            const infoElement = document.getElementById('selectedDatesInfo');
            if (!infoElement) return;
            
            if (selectedDates.size === 0) {
                infoElement.textContent = 'Nenhuma data selecionada';
                return;
            }
            
            const sortedDates = Array.from(selectedDates).sort();
            const formattedDates = sortedDates.map(dateString => {
                const date = new Date(dateString + 'T12:00:00');
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
            });
            
            if (formattedDates.length <= 5) {
                infoElement.textContent = 'Datas: ' + formattedDates.join(', ');
            } else {
                infoElement.textContent = 'Datas: ' + formattedDates.slice(0, 3).join(', ') + ' e mais ' + (formattedDates.length - 3);
            }
        }

        // FunÃ§Ãµes do menu
        async function updateMenuDisplay() {
            const menuElements = {
                'menuSunday': weeklyMenu[0] || 'Carregando...',
                'menuMonday': weeklyMenu[1] || 'Carregando...',
                'menuTuesday': weeklyMenu[2] || 'Carregando...',
                'menuWednesday': weeklyMenu[3] || 'Carregando...',
                'menuThursday': weeklyMenu[4] || 'Carregando...',
                'menuFriday': weeklyMenu[5] || 'Carregando...',
                'menuSaturday': weeklyMenu[6] || 'Carregando...'
            };
            
            Object.entries(menuElements).forEach(([elementId, text]) => {
                const element = document.getElementById(elementId);
                if (element) element.textContent = text;
            });
        }

        // FunÃ§Ãµes de UI
        function updateUI() {
            const isLoggedIn = !!currentUser;
            const isAdmin = currentUser && currentUser.isAdmin;
            
            const elements = {
                userInfo: document.getElementById('userInfo'),
                loginBtn: document.getElementById('loginBtn'),
                registerBtn: document.getElementById('registerBtn'),
                dashboardBtn: document.getElementById('dashboardBtn'),
                ordersBtn: document.getElementById('ordersBtn'),
                reportsBtn: document.getElementById('reportsBtn'),
                adminBtn: document.getElementById('adminBtn'),
                logoutBtn: document.getElementById('logoutBtn')
            };
            
            Object.entries(elements).forEach(([key, element]) => {
                if (!element) return;
                
                switch(key) {
                    case 'userInfo':
                        element.classList.toggle('hidden', !isLoggedIn);
                        break;
                    case 'loginBtn':
                    case 'registerBtn':
                        element.classList.toggle('hidden', isLoggedIn);
                        break;
                    case 'reportsBtn':
                    case 'adminBtn':
                        element.classList.toggle('hidden', !isAdmin);
                        break;
                    default:
                        element.classList.toggle('hidden', !isLoggedIn);
                }
            });
            
            if (currentUser) {
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                if (userAvatar) userAvatar.textContent = currentUser.name[0].toUpperCase();
                if (userName) userName.textContent = currentUser.name;
            }
        }

        function calculateTotal() {
            const selected = selectedDates.size;
            const total = selected * mealPrice;
            
            const totalPriceElement = document.getElementById('totalPrice');
            const selectedDaysElement = document.getElementById('selectedDays');
            
            if (totalPriceElement) {
                totalPriceElement.textContent = total.toFixed(2).replace('.', ',');
            }
            if (selectedDaysElement) {
                selectedDaysElement.textContent = selected;
            }
        }

        async function updatePriceDisplay() {
            // Carrega preÃ§o atual do Firebase
            await loadConfigFromFirebase();
            
            const priceDisplay = document.getElementById('priceDisplay');
            if (priceDisplay) {
                priceDisplay.textContent = mealPrice.toFixed(2).replace('.', ',');
            }
        }

        // FunÃ§Ãµes de pedidos
        async function saveOrder() {
            if (!currentUser) {
                showNotification('VocÃª precisa fazer login primeiro!', 'warning');
                return;
            }
            
            if (selectedDates.size === 0) {
                showNotification('Selecione pelo menos uma data!', 'warning');
                return;
            }
            
            const selectedDatesArray = Array.from(selectedDates).sort();
            
            const order = {
                userId: currentUser.id,
                userEmail: currentUser.email,
                userName: currentUser.name,
                userSetor: currentUser.setor,
                userLoja: currentUser.loja,
                dates: selectedDatesArray,
                total: selectedDates.size * mealPrice,
                date: new Date().toLocaleDateString('pt-BR'),
                status: 'ativo'
            };
            
            try {
                if (firebaseInitialized) {
                    await saveOrderToFirebase(order);
                } else {
                    // Modo demonstraÃ§Ã£o
                    order.id = 'demo-order-' + window.demoMode.nextId++;
                    window.demoMode.orders.push(order);
                }
                
                clearDates();
                showNotification('Pedido salvo com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                showNotification('Erro ao salvar pedido: ' + error.message, 'error');
            }
        }

        async function loadMyOrders() {
            const loadingElement = document.getElementById('ordersLoading');
            const tableElement = document.getElementById('ordersTable');
            
            if (loadingElement) loadingElement.classList.remove('hidden');
            if (tableElement) tableElement.classList.add('hidden');
            
            try {
                let userOrders = [];
                
                if (firebaseInitialized) {
                    userOrders = await loadMyOrdersFromFirebase();
                } else {
                    // Modo demonstraÃ§Ã£o
                    userOrders = window.demoMode.orders.filter(o => o.userId === currentUser.id);
                }
                
                const totalSpent = userOrders.reduce((sum, o) => sum + (o.total || 0), 0);
                
                document.getElementById('myTotalOrders').textContent = userOrders.length;
                document.getElementById('myTotalSpent').textContent = 'R$ ' + totalSpent.toFixed(0);
                
                const dayCount = {};
                userOrders.forEach(order => {
                    if (order.dates) {
                        order.dates.forEach(dateString => {
                            const date = new Date(dateString + 'T12:00:00');
                            const dayOfWeek = date.getDay();
                            const dayName = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'][dayOfWeek];
                            dayCount[dayName] = (dayCount[dayName] || 0) + 1;
                        });
                    }
                });
                
                const favoriteDay = Object.keys(dayCount).length > 0 
                    ? Object.keys(dayCount).reduce((a, b) => dayCount[a] > dayCount[b] ? a : b)
                    : '-';
                
                document.getElementById('myFavoriteDay').textContent = favoriteDay;
                
                const tableBody = document.getElementById('ordersTableBody');
                if (userOrders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">Nenhum pedido encontrado</td></tr>';
                } else {
                    tableBody.innerHTML = userOrders.map(order => {
                        let datesDisplay = '';
                        if (order.dates) {
                            const formattedDates = order.dates.map(dateString => {
                                const date = new Date(dateString + 'T12:00:00');
                                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
                                const dayName = dayNames[date.getDay()];
                                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ' (' + dayName + ')';
                            });
                            datesDisplay = formattedDates.join(', ');
                        }
                        
                        return '<tr>' +
                            '<td>' + (order.date || 'N/A') + '</td>' +
                            '<td style="font-size: 13px;">' + datesDisplay + '</td>' +
                            '<td style="font-weight: 600; color: #4CAF50;">R$ ' + (order.total || 0).toFixed(2).replace('.', ',') + '</td>' +
                            '<td><span class="badge success">âœ… ' + (order.status || 'ativo') + '</span></td>' +
                            '<td><button class="btn btn-danger" onclick="cancelOrder(\'' + order.id + '\')" style="padding: 5px 10px; font-size: 12px;">âŒ</button></td>' +
                            '</tr>';
                    }).join('');
                }
                
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                showNotification('Erro ao carregar pedidos', 'error');
            } finally {
                if (loadingElement) loadingElement.classList.add('hidden');
                if (tableElement) tableElement.classList.remove('hidden');
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('Tem certeza que deseja cancelar este pedido?')) {
                return;
            }
            
            try {
                if (firebaseInitialized) {
                    await cancelOrderInFirebase(orderId);
                } else {
                    // Modo demonstraÃ§Ã£o
                    const order = window.demoMode.orders.find(o => o.id === orderId);
                    if (order) {
                        order.status = 'cancelado';
                    }
                }
                
                await loadMyOrders();
                showNotification('Pedido cancelado!', 'warning');
            } catch (error) {
                console.error('Erro ao cancelar pedido:', error);
                showNotification('Erro ao cancelar pedido', 'error');
            }
        }

        async function generateReport() {
            const loadingElement = document.getElementById('reportLoading');
            const tableElement = document.getElementById('reportTable');
            
            if (loadingElement) loadingElement.classList.remove('hidden');
            if (tableElement) tableElement.classList.add('hidden');
            
            try {
                // Carrega dados do Firebase ou modo local
                let orders = [];
                let users = [];
                
                if (firebaseInitialized) {
                    orders = await loadAllOrders();
                    users = await loadAllUsers();
                    // ForÃ§a carregar menu mais atual
                    await loadMenuFromFirebase();
                } else {
                    orders = window.demoMode?.orders || [];
                    users = window.demoMode?.users || [];
                }
                
                // Armazena globalmente para uso nas etiquetas e PDF
                allOrders = orders;
                allUsers = users;
                
                console.log('ğŸ“Š Dados carregados para relatÃ³rio:');
                console.log('- Pedidos:', allOrders.length);
                console.log('- UsuÃ¡rios:', allUsers.length);
                console.log('- Menu atual:', weeklyMenu);
                
                const totalOrders = orders.length;
                const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
                const totalUsers = users.length;
                
                // Atualiza estatÃ­sticas
                const totalOrdersElement = document.getElementById('totalOrders');
                const totalRevenueElement = document.getElementById('totalRevenue');
                const totalUsersElement = document.getElementById('totalUsers');
                
                if (totalOrdersElement) totalOrdersElement.textContent = totalOrders;
                if (totalRevenueElement) totalRevenueElement.textContent = 'R$ ' + totalRevenue.toFixed(0);
                if (totalUsersElement) totalUsersElement.textContent = totalUsers;
                
                const tableBody = document.getElementById('reportTableBody');
                if (orders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">Nenhum dado encontrado</td></tr>';
                } else {
                    tableBody.innerHTML = orders.map((order, index) => {
                        let datesDisplay = '';
                        if (order.dates) {
                            const formattedDates = order.dates.map(dateString => {
                                const date = new Date(dateString + 'T12:00:00');
                                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
                                const dayName = dayNames[date.getDay()];
                                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ' (' + dayName + ')';
                            });
                            datesDisplay = formattedDates.join(', ');
                        }
                        
                        const setorNames = {
                            'flv': 'FLV',
                            'balcao': 'BalcÃ£o',
                            'frente_caixa': 'Frente Caixa',
                            'financeiro': 'Financeiro',
                            'cpd': 'CPD',
                            'rh': 'RH',
                            'vinhos': 'Vinhos',
                            'compras': 'Compras',
                            'limpeza': 'Limpeza',
                            'padaria_confeitaria': 'Padaria/Confeitaria',
                            'portaria': 'Portaria'
                        };
                        
                        return '<tr>' +
                            '<td><input type="checkbox" class="order-checkbox" data-order-index="' + index + '" style="margin-right: 5px;"></td>' +
                            '<td style="font-weight: 600;">' + (order.userName || 'N/A') + '</td>' +
                            '<td>' + (setorNames[order.userSetor] || order.userSetor || '-') + '</td>' +
                            '<td>' + (order.userLoja || '-') + '</td>' +
                            '<td style="font-size: 12px;">' + datesDisplay + '</td>' +
                            '<td style="font-weight: 600; color: #4CAF50;">R$ ' + (order.total || 0).toFixed(2).replace('.', ',') + '</td>' +
                            '<td>' + (order.date || 'N/A') + '</td>' +
                            '</tr>';
                    }).join('');
                }
                
            } catch (error) {
                console.error('Erro ao gerar relatÃ³rio:', error);
                showNotification('Erro ao gerar relatÃ³rio', 'error');
            } finally {
                if (loadingElement) loadingElement.classList.add('hidden');
                if (tableElement) tableElement.classList.remove('hidden');
            }
        }

        function exportCSV() {
            if (allOrders.length === 0) {
                return showNotification('Nenhum dado para exportar!', 'warning');
            }
            
            const setorNames = {
                'flv': 'FLV',
                'balcao': 'BalcÃ£o',
                'frente_caixa': 'Frente Caixa',
                'financeiro': 'Financeiro',
                'cpd': 'CPD',
                'rh': 'RH',
                'vinhos': 'Vinhos',
                'compras': 'Compras',
                'limpeza': 'Limpeza',
                'padaria_confeitaria': 'Padaria/Confeitaria',
                'portaria': 'Portaria'
            };
            
            let csvContent = 'Usuario,Setor,Loja,Datas_com_Dias,Valor,Data_Pedido\n';
            
            allOrders.forEach(order => {
                let datesDisplay = '';
                if (order.dates) {
                    const formattedDates = order.dates.map(dateString => {
                        const date = new Date(dateString + 'T12:00:00');
                        const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
                        const dayName = dayNames[date.getDay()];
                        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ' (' + dayName + ')';
                    });
                    datesDisplay = formattedDates.join('; ');
                }
                
                csvContent += (order.userName || 'N/A') + ',' +
                    (setorNames[order.userSetor] || order.userSetor || '-') + ',' +
                    (order.userLoja || '-') + ',' +
                    datesDisplay + ',' +
                    'R$ ' + (order.total || 0).toFixed(2).replace('.', ',') + ',' +
                    (order.date || 'N/A') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio-emporio-villa-borghese.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('CSV exportado!', 'success');
        }

        function exportPDF() {
            if (allOrders.length === 0) {
                showNotification('Nenhum dado para exportar!', 'warning');
                return;
            }
            
            const reportDate = new Date().toLocaleDateString('pt-BR');
            const totalOrders = allOrders.length;
            const totalRevenue = allOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            const totalUsers = new Set(allOrders.map(o => o.userId)).size;
            
            const setorNames = {
                'flv': 'FLV',
                'balcao': 'BalcÃ£o',
                'frente_caixa': 'Frente Caixa',
                'financeiro': 'Financeiro',
                'cpd': 'CPD',
                'rh': 'RH',
                'vinhos': 'Vinhos',
                'compras': 'Compras',
                'limpeza': 'Limpeza',
                'padaria_confeitaria': 'Padaria/Confeitaria',
                'portaria': 'Portaria'
            };
            
            let tableRows = '';
            allOrders.forEach(order => {
                let datesDisplay = '';
                if (order.dates) {
                    const formattedDates = order.dates.map(dateString => {
                        const date = new Date(dateString + 'T12:00:00');
                        const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'];
                        const dayName = dayNames[date.getDay()];
                        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ' (' + dayName + ')';
                    });
                    datesDisplay = formattedDates.join(', ');
                }
                
                tableRows += '<tr>' +
                    '<td><strong>' + (order.userName || 'N/A') + '</strong></td>' +
                    '<td>' + (setorNames[order.userSetor] || order.userSetor || '-') + '</td>' +
                    '<td>' + (order.userLoja || '-') + '</td>' +
                    '<td>' + datesDisplay + '</td>' +
                    '<td>R$ ' + (order.total || 0).toFixed(2).replace('.', ',') + '</td>' +
                    '<td>' + (order.date || 'N/A') + '</td>' +
                    '</tr>';
            });
            
            const htmlContent = '<!DOCTYPE html>' +
                '<html><head><meta charset="UTF-8">' +
                '<title>RelatÃ³rio Villa Borghese</title>' +
                '<style>' +
                'body { font-family: Arial, sans-serif; margin: 20px; }' +
                '.header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ff6b35; padding-bottom: 20px; }' +
                '.stats { display: flex; justify-content: space-around; margin: 30px 0; }' +
                '.stat-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }' +
                '.stat-number { font-size: 24px; font-weight: bold; color: #ff6b35; }' +
                'table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }' +
                'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }' +
                'th { background-color: #ff6b35; color: white; }' +
                'tr:nth-child(even) { background-color: #f2f2f2; }' +
                '</style></head><body>' +
                '<div class="header">' +
                '<h1>ğŸ½ï¸ EmpÃ³rio Villa Borghese</h1>' +
                '<h2>RelatÃ³rio de Pedidos</h2>' +
                '<p>Data: ' + reportDate + '</p>' +
                '</div>' +
                '<div class="stats">' +
                '<div class="stat-item"><div class="stat-number">' + totalOrders + '</div><div>Total Pedidos</div></div>' +
                '<div class="stat-item"><div class="stat-number">R$ ' + totalRevenue.toFixed(0) + '</div><div>Receita</div></div>' +
                '<div class="stat-item"><div class="stat-number">' + totalUsers + '</div><div>UsuÃ¡rios</div></div>' +
                '</div>' +
                '<table><thead><tr><th>UsuÃ¡rio</th><th>Setor</th><th>Loja</th><th>Datas (Dia da Semana)</th><th>Valor</th><th>Data Pedido</th></tr></thead><tbody>' +
                tableRows +
                '</tbody></table>' +
                '</body></html>';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.print();
            
            showNotification('PDF gerado!', 'success');
        }

        // FunÃ§Ãµes de administraÃ§Ã£o
        async function loadAdminPanel() {
            await loadUsers();
            await loadMenuInputs();
            await loadConfigFromFirebase();
            
            const priceInput = document.getElementById('mealPriceInput');
            if (priceInput) {
                priceInput.value = mealPrice.toFixed(2);
            }
        }

        async function loadUsers() {
            const loadingElement = document.getElementById('usersLoading');
            const tableElement = document.getElementById('usersTable');
            
            if (loadingElement) loadingElement.classList.remove('hidden');
            if (tableElement) tableElement.classList.add('hidden');
            
            try {
                const users = await loadAllUsers();
                
                const setorNames = {
                    'flv': 'FLV',
                    'balcao': 'BalcÃ£o',
                    'frente_caixa': 'Frente Caixa',
                    'financeiro': 'Financeiro',
                    'cpd': 'CPD',
                    'rh': 'RH',
                    'vinhos': 'Vinhos',
                    'compras': 'Compras',
                    'limpeza': 'Limpeza',
                    'padaria_confeitaria': 'Padaria/Confeitaria',
                    'portaria': 'Portaria'
                };
                
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = users.map(user => 
                    '<tr>' +
                    '<td>' + (user.name || 'N/A') + '</td>' +
                    '<td>' + (user.email || 'N/A') + '</td>' +
                    '<td>' + (setorNames[user.setor] || user.setor || '-') + '</td>' +
                    '<td>' + (user.loja || '-') + '</td>' +
                    '<td><span class="badge ' + (user.isAdmin ? 'warning' : 'info') + '">' + (user.isAdmin ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ User') + '</span></td>' +
                    '<td><span class="badge success">âœ… ' + (user.status || 'ativo') + '</span></td>' +
                    '<td>' + 
                        (user.isAdmin ? 
                            '<button class="btn btn-secondary" onclick="demoteFromAdmin(\'' + user.email + '\')" style="padding: 5px 10px; font-size: 12px;">ğŸ‘¤ Remover Admin</button>' :
                            '<button class="btn btn-warning" onclick="makeAdminByEmail(\'' + user.email + '\')" style="padding: 5px 10px; font-size: 12px;">ğŸ‘‘ Tornar Admin</button>'
                        ) +
                    '</td>' +
                    '</tr>'
                ).join('');
                
            } catch (error) {
                console.error('Erro ao carregar usuÃ¡rios:', error);
                showNotification('Erro ao carregar usuÃ¡rios', 'error');
            } finally {
                if (loadingElement) loadingElement.classList.add('hidden');
                if (tableElement) tableElement.classList.remove('hidden');
            }
        }

        // FunÃ§Ã£o para promover usuÃ¡rio a admin pelo email
        async function promoteToAdmin() {
            const email = document.getElementById('promoteEmail').value.trim();
            if (!email) {
                showNotification('Digite um email vÃ¡lido!', 'warning');
                return;
            }
            
            await makeAdminByEmail(email);
            document.getElementById('promoteEmail').value = '';
        }

        // FunÃ§Ã£o para tornar usuÃ¡rio admin
        async function makeAdminByEmail(email) {
            try {
                if (!firebaseInitialized) {
                    showNotification('Firebase nÃ£o estÃ¡ configurado!', 'error');
                    return;
                }
                
                const { db, doc, getDoc, updateDoc } = window.firebase;
                const userDoc = await getDoc(doc(db, 'users', email));
                
                if (!userDoc.exists()) {
                    showNotification('UsuÃ¡rio nÃ£o encontrado!', 'error');
                    return;
                }
                
                await updateDoc(doc(db, 'users', email), {
                    isAdmin: true,
                    updatedAt: new Date()
                });
                
                showNotification('UsuÃ¡rio promovido a administrador! ğŸ‘‘', 'success');
                await loadUsers();
                
            } catch (error) {
                console.error('Erro ao promover usuÃ¡rio:', error);
                showNotification('Erro ao promover usuÃ¡rio: ' + error.message, 'error');
            }
        }

        // FunÃ§Ã£o para remover admin
        async function demoteFromAdmin(email) {
            if (!confirm('Tem certeza que deseja remover privilÃ©gios de admin deste usuÃ¡rio?')) {
                return;
            }
            
            try {
                if (!firebaseInitialized) {
                    showNotification('Firebase nÃ£o estÃ¡ configurado!', 'error');
                    return;
                }
                
                const { db, doc, updateDoc } = window.firebase;
                await updateDoc(doc(db, 'users', email), {
                    isAdmin: false,
                    updatedAt: new Date()
                });
                
                showNotification('PrivilÃ©gios de admin removidos!', 'info');
                await loadUsers();
                
            } catch (error) {
                console.error('Erro ao remover admin:', error);
                showNotification('Erro ao remover privilÃ©gios: ' + error.message, 'error');
            }
        }

        async function loadMenuInputs() {
            await loadMenuFromFirebase();
            
            const inputs = {
                'menuSundayInput': weeklyMenu[0] || '',
                'menuMondayInput': weeklyMenu[1] || '',
                'menuTuesdayInput': weeklyMenu[2] || '',
                'menuWednesdayInput': weeklyMenu[3] || '',
                'menuThursdayInput': weeklyMenu[4] || '',
                'menuFridayInput': weeklyMenu[5] || '',
                'menuSaturdayInput': weeklyMenu[6] || ''
            };
            
            Object.entries(inputs).forEach(([inputId, value]) => {
                const input = document.getElementById(inputId);
                if (input) input.value = value;
            });
        }

        async function updatePrice() {
            const priceInput = document.getElementById('mealPriceInput');
            if (priceInput) {
                const newPrice = parseFloat(priceInput.value);
                if (newPrice > 0) {
                    mealPrice = newPrice;
                    
                    try {
                        if (firebaseInitialized) {
                            await saveConfigToFirebase();
                            console.log('PreÃ§o salvo no Firebase:', mealPrice);
                        }
                        
                        showNotification('PreÃ§o atualizado para todos os usuÃ¡rios!', 'success');
                        await updatePriceDisplay();
                        calculateTotal();
                    } catch (error) {
                        console.error('Erro ao salvar preÃ§o:', error);
                        showNotification('Erro ao salvar preÃ§o: ' + error.message, 'error');
                    }
                } else {
                    showNotification('PreÃ§o deve ser maior que zero!', 'error');
                }
            }
        }

        async function updateMenu() {
            const inputs = {
                0: document.getElementById('menuSundayInput'),
                1: document.getElementById('menuMondayInput'),
                2: document.getElementById('menuTuesdayInput'),
                3: document.getElementById('menuWednesdayInput'),
                4: document.getElementById('menuThursdayInput'),
                5: document.getElementById('menuFridayInput'),
                6: document.getElementById('menuSaturdayInput')
            };
            
            Object.entries(inputs).forEach(([dayIndex, input]) => {
                if (input && input.value.trim()) {
                    weeklyMenu[parseInt(dayIndex)] = input.value.trim();
                }
            });
            
            try {
                if (firebaseInitialized) {
                    await saveMenuToFirebase();
                    console.log('Menu salvo no Firebase');
                } else {
                    console.log('Menu atualizado localmente');
                }
                
                // Atualiza a visualizaÃ§Ã£o local imediatamente
                await updateMenuDisplay();
                showNotification('CardÃ¡pio atualizado com sucesso!', 'success');
                
                // ForÃ§a atualizaÃ§Ã£o para todos os usuÃ¡rios conectados
                if (firebaseInitialized) {
                    // Adiciona um timestamp para forÃ§ar detecÃ§Ã£o de mudanÃ§a
                    weeklyMenu.lastUpdated = new Date().toISOString();
                    await saveMenuToFirebase();
                }
                
            } catch (error) {
                console.error('Erro ao salvar menu:', error);
                showNotification('Erro ao salvar menu: ' + error.message, 'error');
            }
        }

        async function generateRandomMenu() {
            const dishes = [
                'Risotto de funghi porcini com trufas',
                'Osso buco milanÃªs com gremolata',
                'Lasanha de berinjela tradicional',
                'SalmÃ£o grelhado com ervas',
                'Linguine alle vongole',
                'Vitello tonnato com alcaparras',
                'Branzino assado com limÃ£o',
                'Parmigiana di melanzane',
                'Ravioli de ricota e espinafre',
                'Frango parmigiana italiano',
                'Gnocchi alla sorrentina',
                'Scaloppine al limone',
                'Fettuccine alfredo',
                'Saltimbocca alla romana',
                'Polenta cremosa com ragu',
                'Capellini pomodoro e basilico',
                'Costela bovina 12h',
                'Risotto de camarÃ£o rosÃ©',
                'Paella valenciana especial',
                'BaccalÃ  alla vicentina'
            ];
            
            // Embaralha os pratos e pega 7
            const shuffled = dishes.sort(() => 0.5 - Math.random());
            const selectedDishes = shuffled.slice(0, 7);
            
            // Atualiza o menu
            for (let i = 0; i < 7; i++) {
                weeklyMenu[i] = selectedDishes[i];
            }
            
            try {
                if (firebaseInitialized) {
                    // Adiciona timestamp para forÃ§ar sincronizaÃ§Ã£o
                    weeklyMenu.lastUpdated = new Date().toISOString();
                    await saveMenuToFirebase();
                    console.log('Menu aleatÃ³rio salvo no Firebase');
                } else {
                    console.log('Menu aleatÃ³rio gerado localmente');
                }
                
                await loadMenuInputs();
                await updateMenuDisplay();
                showNotification('CardÃ¡pio aleatÃ³rio gerado e salvo!', 'success');
                
            } catch (error) {
                console.error('Erro ao salvar menu aleatÃ³rio:', error);
                showNotification('Erro ao salvar menu: ' + error.message, 'error');
            }
        }

        async function resetAllData() {
            if (!confirm('ATENÃ‡ÃƒO: Isso irÃ¡ apagar TODOS os dados do sistema (pedidos, configuraÃ§Ãµes, etc.). Esta aÃ§Ã£o Ã© IRREVERSÃVEL. Continuar?')) {
                return;
            }
            
            if (!confirm('Tem ABSOLUTA certeza? Todos os dados serÃ£o perdidos permanentemente!')) {
                return;
            }
            
            try {
                if (!firebaseInitialized) {
                    showNotification('Firebase nÃ£o estÃ¡ configurado!', 'error');
                    return;
                }
                
                const { db, collection, getDocs, deleteDoc, doc } = window.firebase;
                
                // Remove todos os pedidos
                const ordersSnapshot = await getDocs(collection(db, 'orders'));
                const deleteOrderPromises = ordersSnapshot.docs.map(orderDoc => 
                    deleteDoc(doc(db, 'orders', orderDoc.id))
                );
                await Promise.all(deleteOrderPromises);
                
                // Remove todas as configuraÃ§Ãµes (exceto usuÃ¡rios por seguranÃ§a)
                const configSnapshot = await getDocs(collection(db, 'config'));
                const deleteConfigPromises = configSnapshot.docs.map(configDoc => 
                    deleteDoc(doc(db, 'config', configDoc.id))
                );
                await Promise.all(deleteConfigPromises);
                
                // Redefine valores padrÃ£o
                mealPrice = 18.50;
                weeklyMenu = {
                    0: 'Paella valenciana especial',
                    1: 'Risotto de funghi com trufas',
                    2: 'SalmÃ£o grelhado mediterrÃ¢neo',
                    3: 'Osso buco milanÃªs',
                    4: 'Lasanha de berinjela',
                    5: 'Risotto de camarÃ£o',
                    6: 'Costela 12h com gnocchi'
                };
                
                // Salva configuraÃ§Ãµes padrÃ£o
                await saveConfigToFirebase();
                await saveMenuToFirebase();
                
                showNotification('Sistema resetado com sucesso!', 'success');
                
                // Recarrega dados
                await loadAdminPanel();
                
            } catch (error) {
                console.error('Erro ao resetar sistema:', error);
                showNotification('Erro ao resetar sistema: ' + error.message, 'error');
            }
        }

        // Disponibiliza funÃ§Ãµes globalmente para debug
        window.debugFunctions = {
            exportPDF: exportPDF,
            testPDF: function() {
                console.log('ğŸ§ª Teste direto da funÃ§Ã£o PDF');
                console.log('allOrders:', allOrders);
                console.log('weeklyMenu:', weeklyMenu);
                exportPDF();
            },
            showData: function() {
                console.log('ğŸ“Š Dados atuais:');
                console.log('- allOrders:', allOrders);
                console.log('- allUsers:', allUsers);
                console.log('- weeklyMenu:', weeklyMenu);
                console.log('- currentUser:', currentUser);
            }
        };

        // ForÃ§a associar a funÃ§Ã£o ao botÃ£o
        document.addEventListener('DOMContentLoaded', function() {
            // Garante que o modal esteja fechado na inicializaÃ§Ã£o
            const modal = document.getElementById('labelModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            showLogin();
            updateUI();
            initFirebase();
            
            // ForÃ§a associar eventos apÃ³s DOM carregar
            setTimeout(() => {
                console.log('ğŸ”§ Verificando botÃµes...');
                
                // Verifica se os botÃµes existem
                const pdfBtn = document.querySelector('button[onclick="exportPDF()"]');
                const csvBtn = document.querySelector('button[onclick="exportCSV()"]');
                const reportBtn = document.querySelector('button[onclick="generateReport()"]');
                
                console.log('BotÃ£o PDF encontrado:', !!pdfBtn);
                console.log('BotÃ£o CSV encontrado:', !!csvBtn);
                console.log('BotÃ£o RelatÃ³rio encontrado:', !!reportBtn);
                
                // ForÃ§a recriar evento do PDF
                if (pdfBtn) {
                    pdfBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('ğŸ–±ï¸ BotÃ£o PDF clicado via addEventListener');
                        exportPDF();
                    });
                }
            }, 2000);
        });

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // ESC para limpar seleÃ§Ã£o de datas
            if (e.key === 'Escape' && currentUser) {
                clearDates();
            }
            
            // Ctrl/Cmd + Enter para salvar pedido
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && currentUser) {
                e.preventDefault();
                saveOrder();
            }
        });

        // Auto-refresh dos dados a cada 30 segundos (mais frequente)
        setInterval(async function() {
            if (firebaseInitialized && currentUser) {
                try {
                    // Carrega menu atual do Firebase
                    const oldMenu = JSON.stringify(weeklyMenu);
                    await loadMenuFromFirebase();
                    const newMenu = JSON.stringify(weeklyMenu);
                    
                    // Se o menu mudou, atualiza a visualizaÃ§Ã£o
                    if (oldMenu !== newMenu) {
                        console.log('Menu atualizado detectado, sincronizando...');
                        await updateMenuDisplay();
                        showNotification('CardÃ¡pio atualizado! ğŸ½ï¸', 'info');
                    }
                    
                    // Carrega configuraÃ§Ãµes (preÃ§os)
                    const oldPrice = mealPrice;
                    await loadConfigFromFirebase();
                    
                    // Se o preÃ§o mudou, atualiza a visualizaÃ§Ã£o
                    if (oldPrice !== mealPrice) {
                        console.log('PreÃ§o atualizado detectado:', mealPrice);
                        await updatePriceDisplay();
                        calculateTotal();
                        showNotification('PreÃ§o atualizado! ğŸ’°', 'info');
                    }
                    
                    console.log('SincronizaÃ§Ã£o automÃ¡tica concluÃ­da');
                } catch (error) {
                    console.error('Erro na sincronizaÃ§Ã£o automÃ¡tica:', error);
                }
            }
        }, 30000); // 30 segundos

        // SincronizaÃ§Ã£o quando a pÃ¡gina ganha foco (usuÃ¡rio volta para a aba)
        document.addEventListener('visibilitychange', async function() {
            if (!document.hidden && firebaseInitialized && currentUser) {
                console.log('PÃ¡gina ganhou foco, sincronizando dados...');
                try {
                    await loadMenuFromFirebase();
                    await loadConfigFromFirebase();
                    await updateMenuDisplay();
                    await updatePriceDisplay();
                    calculateTotal();
                } catch (error) {
                    console.error('Erro na sincronizaÃ§Ã£o por foco:', error);
                }
            }
        });
    </script>
</body>
</html>